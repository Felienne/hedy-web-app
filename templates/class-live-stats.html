{% extends "auth.html" %}

{% block regular_content %}

<div>
    <!--  Back to class button  -->
    <button class="green-btn float-right" id="to_class_button" onclick="window.location.href='/for-teachers/class/{{class_info.id}}'">
      {{_('back_to_class')}}
    </button>

    <!-- Title  -->
    <div class="flex flex-col gap-4">
        <div class="font-bold font-slab text-sky-600 text-2xl">
            <h1>RADboard</h1>
        </div>
    </div>

    <!-- Card 1 Progress indicator collapsed version -->
    <div class="justify-center">
        <h2 class="text-center">Class Overview</h2>
        <!-- Hide / Show -->
        <div class="float-right relative m-2">
            {% if dashboard_options.show_c1 %}
                {% if dashboard_options.student %}
                    <a class="no-underline text-black rounded hover:bg-blue-600"
                       href="/live_stats/class/{{class_info.id}}/student?{{ dashboard_options_args | replace('show_c1=True', 'show_c1=False') }}">
                        ‚òùÔ∏è Hide
                    </a>
                {% else %}
                    <a class="no-underline text-black rounded hover:bg-blue-600"
                       href="/live_stats/class/{{class_info.id}}?{{ dashboard_options_args | replace('show_c1=True', 'show_c1=False') }}">
                        ‚òùÔ∏è Hide
                    </a>
                {% endif %}
            {% else %}
                {% if dashboard_options.student %}
                    <a class="no-underline text-black rounded hover:bg-blue-600"
                       href="/live_stats/class/{{class_info.id}}/student?{{ dashboard_options_args | replace('show_c1=False', 'show_c1=True') }}">
                        üëá Show
                    </a>
                {% else %}
                    <a class="no-underline text-black rounded hover:bg-blue-600"
                       href="/live_stats/class/{{class_info.id}}?{{ dashboard_options_args | replace('show_c1=False', 'show_c1=True') }}">
                        üëá Show
                    </a>
                {% endif %}

            {% endif %}
        </div>

        <div class="w-full max-w-8xl rounded-lg bg-blue-200 p-6 shadow-lg" id="card1_class_overview">
            {% if dashboard_options.show_c1 %}
            <div class="w-full">
                <!-- Levels selector -->
                <div class="flex justify-center">
                    <div>
                        {% for i in range(1, max_level + 1) %}
                            <button class="level-select-button {% if i in class_info.class_overview.selected_levels %}green-btn{% else %}gray-btn{% endif %} h-8 w-6 p-1 text-sm" id="level_button_{{ i }}" data-cy="enable_level_{{ i }}" onclick="hedyApp.enable_level_class_overview('{{ i }}');" value="{{ i }}">{{ i }}</button>
                        {% endfor %}
                    </div>
                    <button class="blue-btn p-1 ml-4 h-8 text-sm" id="level_button_{{ i }}" onclick="hedyApp.select_levels_class_overview('{{class_info.id}}')">Select levels</button>
                </div>
                <!-- Adventures per level -->
                {% for selected_level in class_info.class_overview.selected_levels %}
                <p class="text-blue-600 font-bold mr-2 ml-4 mt-8">{{_('level')}} {{ selected_level }}</p>
                <div class="text-sm font-medium text-center text-blue-600 border-b-2 border-gray-200">
                    <ul class="flex flex-wrap -mb-px list-none">
                    {% for level, adventure_list in adventures.items() %}
                        {% if level|int == selected_level %}
                            {% for adventure in adventure_list %}
                            <li class="mr-1">
                                <div class="inline-block p-4 text-gray-700">
                                    {{ adventure["name"] }}
                                    {% if adventure["in_progress"] != 0 %}
                                        <span class="ml-2 bg-blue-100 text-blue-800 text-xs font-medium mr-1 px-2.5 py-0.5 rounded-full">{{ adventure["in_progress"] }}</span>
                                    {% endif %}
                                </div>
                            </li>
                            {% endfor %}
                            <li class="mr-1">
                                <div class="inline-block p-4 text-green-700 border-b-4 border-green-600">
                                    Quiz
                                    {% set in_progress = quiz_info[selected_level]["students_in_progress"]|length %}
                                    {% set finished = quiz_info[selected_level]["students_finished"]|length %}
                                    {% if in_progress != 0 %}
                                    <span class="ml-1 bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">{{ in_progress }}</span>
                                    {% endif %}
                                    {% if finished != 0 %}
                                    <span class="ml-1 bg-green-600 text-white text-xs font-medium px-2.5 py-0.5 rounded-full">{{ finished }}</span>
                                    {% endif %}
                                </div>
                            </li>
                        {% endif %}
                    {% endfor %}
                    </ul>
                </div>
                {%endfor%}
            </div>
            <!-- Legend -->
            <div class="mt-5 flex">
                <div class="flex m-1">
                    <div><span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Nr.</span></div>
                    <p class="text-xs font-semibold text-gray-700 mt-1">In progress</p>
                </div>
                <div class="flex m-1 ml-3">
                    <div><span class="bg-green-600 text-white  text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Nr.</span></div>
                    <p class="text-xs font-semibold text-green-800 mt-1">Quiz finished</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Space for Student Details card, otherwise empty -->
    {% block student_space %}
    {% endblock %}


    <div class="justify-center w-full max-w-8xl">
        <div class="grid grid-cols-2 gap-4 my-8" id="columns_grid">
            <!-- Card 2 Student List    -->
            <div id="col1">
                <h2 class="text-center">
                  Student List
                </h2>
                {% if dashboard_options.show_c2 %}
                <div class="rounded-lg bg-blue-200 shadow-lg p-0 h-64 overflow-auto" id="card2_list">
                    <div class="float-right relative m-2">
                        {% if dashboard_options.student %}
                        <a class="no-underline text-black rounded hover:bg-blue-600"
                           href="/live_stats/class/{{class_info.id}}/student?{{ dashboard_options_args | replace('show_c2=True', 'show_c2=False') }}">
                            ‚òùÔ∏è Hide
                        </a>
                        {% else %}
                        <a class="no-underline text-black rounded hover:bg-blue-600"
                           href="/live_stats/class/{{class_info.id}}?{{ dashboard_options_args | replace('show_c2=True', 'show_c2=False') }}">
                            ‚òùÔ∏è Hide
                        </a>
                        {% endif %}
                    </div>

                    <table class="table-auto w-full border-separate space-y-6 border border-black rounded-lg">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="px-4 py-2 text-left">{{_('name')}}</th>
                                <!-- This is a bucket-fix to get the first letter capitalized, should find a long-term solution -->
                                <th class="p-2">{{_('Adventure Progress')}}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s in student_names %}
                            <tr>
                                <td class="px-2">
                                    {% if dashboard_options.student %}
                                        <a href="/live_stats/class/{{class_info.id}}/student?{{dashboard_options_args | replace('student='~dashboard_options.student, 'student='~s)}}" class="text-black hover:text-white" id="show-student">
                                            {{s}}
                                        </a>
                                    {% else %}
                                        <a href="/live_stats/class/{{class_info.id}}/student?{{dashboard_options_args | replace('student=None', 'student='~s)}}" class="text-black hover:text-white" id="show-student">
                                            {{s}}
                                        </a>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="h-6 w-6 rounded-full bg-blue-600 hover:bg-purple-700">
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="rounded-lg bg-blue-200 shadow-lg p-0 overflow-auto" id="card2_list_hidden">
                    <div class="float-right relative m-2">
                        {% if dashboard_options.student %}
                        <a class="no-underline text-black rounded hover:bg-blue-600"
                        href="/live_stats/class/{{class_info.id}}/student?{{ dashboard_options_args | replace('show_c2=False', 'show_c2=True') }}">
                        üëá Show
                        </a>
                        {% else %}
                        <a class="no-underline text-black rounded hover:bg-blue-600"
                        href="/live_stats/class/{{class_info.id}}?{{ dashboard_options_args | replace('show_c2=False', 'show_c2=True') }}">
                        üëá Show
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Card 3 Common Errors -->
            <div id="col2">
                <div class="flex justify-center text-blue-500 space-x-3">
                        <h2>
                            Common Errors
                        </h2>
                        <div class="relative">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
                            </svg>
                            <div class='text-center tooltip opacity-0 hover:opacity-100 duration-300 absolute inset-0 z-10 flex justify-center items-top -ml-32 mt-0.5'>
                                <span class='tooltiptext text-xs font-medium absolute rounded shadow-lg p-1 w-72' style="color:black"> {{"The common errors are gathered by an AI system. It detects and clusters code submissions that fail to run.
The system is not foolproof! It is possible that students make errors that are not detected."}} </span>
                                </span>
                            </div>
                        </div>
                </div>
                {% if dashboard_options.show_c3 %}
                <div class="rounded-lg bg-blue-200 shadow-lg p-0 h-64 overflow-auto" id="card3_misconceptions">
                    <div class="float-right relative m-2">
                        {% if dashboard_options.student %}
                        <a class="no-underline text-black rounded hover:bg-blue-600"
                           href="/live_stats/class/{{class_info.id}}/student?{{ dashboard_options_args | replace('show_c3=True', 'show_c3=False') }}">
                            ‚òùÔ∏è Hide
                        </a>
                        {% else %}
                        <a class="no-underline text-black rounded hover:bg-blue-600"
                           href="/live_stats/class/{{class_info.id}}?{{ dashboard_options_args | replace('show_c3=True', 'show_c3=False') }}">
                            ‚òùÔ∏è Hide
                        </a>
                        {% endif %}
                    </div>
                    <div class="w-full text-left p-6 mt-1">
                        <ul class="max-w-md space-y-1 list-none list-inside">
                            {% for error_entry in class_info.common_errors.errors %}
                                {% if error_entry.active == 1 %}
                                    <li class="relative w-full border-solid border-2 border-black rounded p-2" id="{{ ident }}">
                                      <a class="no-underline"  href='{{ "/live_stats/class/"~class_info.id~"/pop_up?"~ dashboard_options_args}}'>
                                        <h3 class="cursor-pointer hover:text-white">
                                          {{error_entry.header}}
                                        </h3>
                                      </a>
                                      <a href="#" class="absolute text-black right-5 top-0 no-underline hover:text-white" id="resolve-student" onclick='hedyApp.resolve_student("{{ class_info.id }}", "{{error_entry.id}}", {{('resolve_student_prompt')|default(None)|tojson}})'>‚úîÔ∏è Resolve</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                  </div>
                </div>
                {% else %}
                <div class="rounded-lg bg-blue-200 shadow-lg p-0 overflow-auto" id="card3_misconceptions_hidden">
                    <div class="float-right relative m-2">
                        {% if dashboard_options.student %}
                        <a class="no-underline text-black rounded hover:bg-blue-600"
                        href="/live_stats/class/{{class_info.id}}/student?{{ dashboard_options_args | replace('show_c3=False', 'show_c3=True') }}">
                        üëá Show
                        </a>
                        {% else %}
                        <a class="no-underline text-black rounded hover:bg-blue-600"
                        href="/live_stats/class/{{class_info.id}}?{{ dashboard_options_args | replace('show_c3=False', 'show_c3=True') }}">
                        üëá Show
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% block popup_content %}
    {% endblock %}
</div>

{% endblock %}
