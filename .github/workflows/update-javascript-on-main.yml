# Script to update files that should have been automatically generated.
name: Automatically update generated files

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  update_javascript:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      name: Checkout branch (with token)
      if: github.event_name == 'push'
      with:
        fetch-depth: 1

        # We need to pass the token here -- the commit action below will not overwrite the token to push.
        token: ${{ secrets.FELIENNE_GITHUB_ACCESS_TOKEN }}
    - uses: actions/checkout@v4
      name: Checkout branch (on pull requests)
      if: github.event_name != 'push'
      with:
        fetch-depth: 1
    - name: Set up Python 3.12
      uses: actions/setup-python@v1
      with:
        python-version: 3.12
    - name: Install Python dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt

    - name: Automatically updating generated files
      run: |
        doit run _autopr

    - name: Commit changed files
      uses: stefanzweifel/git-auto-commit-action@v2.3.0
      if: github.event_name == 'push'
      with:
        commit_message: Automatically update generated files ðŸ¤– beep boop
        branch: ${{ github.ref_name }}
      env:
        # This is necessary to bypass branch protection (which will disallow non-reviewed pushes otherwise)
        GITHUB_TOKEN: ${{ secrets.FELIENNE_GITHUB_ACCESS_TOKEN }}
